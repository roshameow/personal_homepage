---
layout: post
title: å°é¢ç§¯å…‰æµä¼ æ„Ÿå™¨ç®—æ³•æµ‹è¯• (ä¸€)
categories:
  - algorithm
tags:
  - content
  - optical_flow
  - opencv
  - test
last_modified_at: 2024-05-08T22:26:59-08:00
---
å¤§æ¦‚åˆ†ä¸º: preprocess -> instant flow compute -> filter correct ä¸‰ä¸ªæ­¥éª¤

## è®¡ç®—è¿ç»­ä¸¤å¸§çš„å…‰æµ

| ç®—æ³•                                                                      | æ”¹è¿›                                                                           | å…¬å¼                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | æ•ˆæœ                                                                                      | å­˜å‚¨å ç”¨                                                        |
| ----------------------------------------------------------------------- | ---------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------- | ----------------------------------------------------------- |
| LK<br>[Lucas-Kanade](https://en.wikipedia.org/wiki/Lucasâ€“Kanade_method) |                                                                              | å¯¹å›¾åƒ$I$ çš„æ¯ä¸ªåƒç´ , æœ‰ $\frac{\partial I}{\partial x}dx+\frac{\partial I}{\partial y}dy=\frac{dI}{dt}$ <br>å³, $\begin{bmatrix}dx \\\ dy\end{bmatrix}=\begin{bmatrix}\frac{\partial I}{\partial x}\frac{\partial I}{\partial x} & \frac{\partial I}{\partial x}\frac{\partial I}{\partial y} \\\ \frac{\partial I}{\partial x}\frac{\partial I}{\partial y} & \frac{\partial I}{\partial y}\frac{\partial I}{\partial y} \end{bmatrix}^{-1}\begin{bmatrix}\frac{\partial I}{\partial x}\frac{dI}{dt} \\\ \frac{\partial I}{\partial y}\frac{dI}{dt}\end{bmatrix}=H^{-1}\begin{bmatrix}\frac{\partial I}{\partial x}\frac{dI}{dt} \\\ \frac{\partial I}{\partial y}\frac{dI}{dt}\end{bmatrix}$<br>å…¶ä¸­$\frac{\partial I}{\partial x}\approx I(x+1,y)-I(x,y)$  <br> | åªåœ¨å…‰æµåœ¨0-1é™„è¿‘æœ‰æ•ˆ(å³subpixelçš„å°ºåº¦)<br><br>å’Œ$\frac{\partial I}{\partial x}$ çš„è®¡ç®—æ–¹å¼æœ‰å…³              |                                                             |
|                                                                         | LK_MEAN_NORM<br>                                                             | æŠŠ$\frac{dI}{dt}$ æ”¹ä¸º $\frac{dI}{dt}-mean(\frac{dI}{dt})$<br>($mean(\frac{dI}{dt})$ è¡¨ç¤ºæ•´ä½“äº®åº¦çš„å˜åŒ–, å’Œå…‰æµæ— å…³)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | è§£å†³äº®åº¦å˜åŒ–çš„æƒ…å†µ                                                                               |                                                             |
|                                                                         | @pre_shift                                                                   | å…ˆå¯¹é½åˆ°ä¸Šä¸€æ¬¡è®¡ç®—çš„å…‰æµä½ç½®                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                                                                                         |                                                             |
|                                                                         | @compute_pyd                                                                 | æŠŠå›¾åƒåˆ†ä¸ºå¤šå±‚ä¸‹é‡‡æ ·è®¡ç®—                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                                                                                         |                                                             |
|                                                                         | LK-DIS<br>dense inverse search<br>ç»“åˆä¸¤ç§æ–¹æ³•                                     | åˆ†å—è®¡ç®—<br>- æ¯å—éƒ½è¿­ä»£è®¡ç®—å…‰æµ<br>&ensp;&ensp;- å…ˆæŒ‰æ•´åƒç´ ç§»åŠ¨åˆ°ssdæœ€å°çš„ä½ç½®<br>&ensp;&ensp; - å†ç”¨LK_MEAN_NORMçš„æ–¹æ³•ä¸æ–­å¾®è°ƒè®¡ç®—å…‰æµ<br>&ensp;&ensp; &ensp; &ensp; - æŒ‰ç…§å…‰æµè®¡ç®—çš„æ–¹å‘å¯¹é½, è®¡ç®—ssd<br> &ensp;&ensp;&ensp; &ensp;  - ssdä¸å†å˜å°å°±è·³å‡ºå¾ªç¯<br>ç”¨æ‰€æœ‰åˆ†å—çš„å¹³å‡å…‰æµä½œä¸ºæœ€ç»ˆç»“æœ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | æ¯”LKæ›´ç¨³å®š                                                                                  | éœ€è¦æ‰€æœ‰patchçš„Hessian, dx, dyçŸ©é˜µ<br><br>å¯¹é½patchæ—¶ç§»åŠ¨patchçš„ä¸­é—´ç»“æœ<br> |
| åƒç´ neighbor patchæ¯”å¯¹<br>                                                  |                                                                              | $diff=dist(F(I_1(x,y))-F(I_2(x+dx,y+dy)))$ <br><br>$argmin_{(dx,dy)}\sum_{x,y}dist(F(I_1(x,y))-F(I_2(x+dx,y+dy)))$ <br>å…¶ä¸­, $F$ æ˜¯ç‰¹å¾æå–å™¨, distæ˜¯è·ç¦»å‡½æ•°                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                                                                                         |                                                             |
| : ç‰¹å¾                                                                    | SAD_SIMPLE<br>sum of average differences                                     | $sad=L_1(diff)$<br>æˆ–è€…$sad=L_1(diff-mean(diff))$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | ç¬¬äºŒç§æ›´å¥½                                                                                   |                                                             |
|                                                                         | SAD_SUBPIXEL<br>ç”¨å¤šé¡¹å¼æ‹Ÿåˆsadå¹³é¢<br>(opencv Farneback<br>ä¹Ÿæ˜¯ç”¨å¤šé¡¹å¼æ‹Ÿåˆ, <br>ä¸è¿‡æ‹Ÿåˆçš„æ˜¯åŸå›¾åƒ) | $P(x+\Delta x)\approx P(x)+P^\prime(x)\Delta x+\frac{P^{\prime\prime}(x)}{2}\Delta x^2$ <br>å³, $\Delta x=-\frac{P^\prime(x)}{P^{\prime\prime}(x)}$ <br>å…¶ä¸­ $P^\prime(x)\approx \frac{dist(x+1,y)-dist(x-1,y)}{2}$ , $P^{\prime\prime}$ ç±»ä¼¼<br>-  dx, dyåˆ†å¼€è®¡ç®—<br>- ç›´æ¥ç”¨å¤šé¡¹å¼ä»£å…¥ä¹Ÿæ˜¯ç­‰ä»·çš„                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | æ²¡ç”¨<br>å¯èƒ½æ˜¯å› ä¸ºsubpixelçš„éƒ¨åˆ†ä¸ç¬¦åˆå¤šé¡¹å¼                                                            |                                                             |
|                                                                         | SAD_BLUR                                                                     | å…ˆå¯¹å›¾åƒåš2x2çš„blur<br>ğŸ˜®â€ğŸ’¨å› ä¸ºè§‰å¾—ä¸å‡†çš„åœ°æ–¹æ˜¯ä¸æ˜¯å› ä¸ºåˆšå¥½å¯¹é½çš„åœ°æ–¹åœ¨åƒç´ çš„ä¸­é—´                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | åƒåœ¾<br>                                                                                  |                                                             |
| : è·ç¦»<br>                                                                | SSD_SIMPLE<br>sum of squared differences<br>                                 | $ssd=Var(diff)$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | æ¯”SADç¨³å®š                                                                                  |                                                             |
|                                                                         | SAD_BINARY                                                                   | $hamming=popcount(ref\ \hat\ current)$<br>å…¶ä¸­å›¾åƒæ˜¯binary(image-mean(image))                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | æ•ˆæœæ˜æ˜¾å˜å·®<br>binaryæœ‰æ²¡æœ‰å¿…è¦å‘¢?                                                                 |                                                             |
|                                                                         | BINARY_FEATURE                                                               | ç”¨gradient descentè®­ç»ƒä¸€ä¸ªç‰¹å¾                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                                                                                         |                                                             |
|                                                                         | BINARY_FEATURE_BOOST                                                         | ç”¨adaboostè®­ç»ƒä¸€ä¸ªç‰¹å¾                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                                                                                         |                                                             |
| : neighbor                                                              | SAD_SIMPLE_CROSS<br>neighborå˜æˆcrosså½¢çŠ¶, èŠ‚çœä¸€äº›å­˜å‚¨                                |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | èŠ‚çœå­˜å‚¨&è®¡ç®—<br>                                                                             |                                                             |
|                                                                         | SAD_SPIRAL                                                                   | - ä»ä¸Šä¸€æ¬¡çš„å…‰æµä½ç½®å‘å¤–èºæ—‹çŠ¶è®¡ç®—<br>- é‡åˆ°æ›´å°çš„distanceæå‰ç»“æŸå¾ªç¯                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | èŠ‚çœå­˜å‚¨&è®¡ç®—<br>å’ŒLKæ•ˆæœç±»ä¼¼<br>åº”è¯¥æ˜¯éƒ½ç”¨äº†preshiftçš„åŸå›                                                  |                                                             |
| [phase_correlation](https://en.wikipedia.org/wiki/Phase_correlation)    |                                                                              | $dx,dy=argmax_{x,y} F^{-1}(\frac{F(I_1)\cdot \bar{F(I_2)}}{\|F(I_1)\cdot \bar{F(I_2)}\|})$ <br>ç›¸å½“äºæå–å›¾åƒçš„phaseéƒ¨åˆ†<br>ç„¶åç”¨cross correlationçš„dist                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | åœ¨ä½ç§»å¤ªå¤§æ—¶æ•ˆæœä¸å¥½<br>å…‰æµåœ¨0-6æ—¶æ•ˆæœå¯ä»¥ <br>å¦å¤–å¦‚æœä¸åšphase correlation,<br>ç›´æ¥åšcross correlation<br>æ•ˆæœå¹¶ä¸å¥½ | éœ€è¦refå’Œcurrentçš„ffté¢‘åŸŸ                                         |


## æµ‹è¯•

- ä»¿çœŸæ•°æ®: è·ç¦»ä»¿çœŸæ•°æ®çš„ä½ç½®
- çœŸå®æ•°æ®:
	- ç¨³å®šæ€§: ç”µæœºå¸¦åŠ¨åŒ€é€Ÿè½¬åŠ¨
	- å“åº”é€Ÿåº¦: ç”µæœºæ€¥åœæ€¥è½¬


ä¸€äº›ç»“æœ$\downarrow$

![result_compare_2000_test.png]({{ '/docs/attachment/result_compare_2000_test.png' | relative_url }}){:width="400"}  ![Pasted image 20240425142720.png]({{ '/docs/attachment/Pasted image 20240425142720.png' | relative_url }}){:width="400"} 

- å¯¹äºæµ‹è¯•åœºæ™¯æ¥è¯´, æ‰€æœ‰subpixelçš„æ–¹æ³•ä¼¼ä¹éƒ½æ²¡æœ‰å¿…è¦
- phase correlation > è®­ç»ƒå¾—åˆ°çš„å‡ ç§ç‰¹å¾å¹³ç§»åŒ¹é… $\approx$ sad(-mean(diff)) $\approx$ ssd > sad binary >> sad spiral $\approx$ LK
	- **å¯¹å›¾åƒåšdetailçš„æå–(å¦‚image-blur(image,(6x6)))** ä¹‹å, sadçš„ç»“æœå¾—åˆ°æé«˜, å’Œè®­ç»ƒå¾—åˆ°çš„ç‰¹å¾ç±»ä¼¼
	- å‡ ä¸ªç‰¹å¾å¹³ç§»æ–¹æ³•å‡ºç°é”™è¯¯çš„åœ°æ–¹å¯èƒ½å› ä¸ºè¶…å‡ºäº†æœç´¢èŒƒå›´å¯¼è‡´çš„
	-  å¹³ç§»ådiffçš„ä¾‹å­: ![Pasted image 20240425151045.png]({{ '/docs/attachment/Pasted image 20240425151045.png' | relative_url }}){:width="100"} 
- å“åº”çš„æµ‹è¯•: é™¤äº†lkä¼šååº”æ…¢ä¸€äº›, å…¶ä»–éƒ½åœ¨å¯ä»¥æ¥å—èŒƒå›´å†…
- è¿™çœŸæ˜¯ä¸ªç‰¹åˆ«æ¯ç‡¥çš„å·¥ä½œğŸ˜‘, å¾ˆå¤šæ–¹æ³•è§‰å¾—, å•Š, åº”è¯¥ä¸ä¼šæœ‰æ•ˆæœçš„, ä½†è¿˜æ˜¯æƒ³ç€, åšæŒç€å†™å‡ºæ¥æµ‹ä¸€ä¸‹ç©¶ç«Ÿå·®åœ¨å“ªé‡Œå§

## å‡ ç§opencvæ”¯æŒçš„æ–¹æ³•æµ‹è¯•

- ä»£ç : [**flow_opencv.py**](https://gist.github.com/roshameow/7843f23826791c152ab2ed8c169590b9#file-flow_opencv-py) 
- å¤ç°ä¿®æ”¹opencvçš„ç®—æ³•, æœ‰æ—¶éœ€è¦opencvä»£ç çš„ä¸­é—´ç»“æœ
	- å› ä¸ºæˆ‘æ²¡æœ‰ä¸‹è½½opencvå®Œæ•´çš„æºç , è€Œæ˜¯ç”¨pipè£…opencvçš„åº“
	- ç”¨`pkg-config --cflags --libs opencv4` æŸ¥çœ‹opencvçš„lib,include path
	- å•ç‹¬æŠŠè¦å¤ç°çš„å‡½æ•°å¤åˆ¶ä¸€ä¸ª.cpp, å°±å¯ä»¥éšä¾¿æ‰“å°ä¸­é—´ç»“æœäº†



## æœ‰ç”¨çš„é“¾æ¥

[1] https://dsp.stackexchange.com/questions/16995/image-reconstructionphase-vs-magnitude å…³äºå›¾åƒphaseéƒ¨åˆ†çš„æé—®

[2] https://homepages.inf.ed.ac.uk/rbf/CVonline/LOCAL_COPIES/OWENS/LECT7/node2.html è§£é‡Šå›¾åƒè¾¹ç¼˜éƒ¨åˆ†çš„[Phase congruency](https://en.wikipedia.org/wiki/Phase_congruency#:~:text=Phase%20congruency%20is%20a%20measure,changes%20in%20illumination%20and%20contrast.) æ›´å¼º

![åŸå›¾](https://homepages.inf.ed.ac.uk/rbf/CVonline/LOCAL_COPIES/OWENS/LECT7/img31.gif) ![PCå›¾](https://homepages.inf.ed.ac.uk/rbf/CVonline/LOCAL_COPIES/OWENS/LECT7/img33.gif) ç”¨Phase Congruencyæå–å›¾åƒè¾¹ç¼˜çš„ç»“æœ

[3]  [Phase stretch Transform](https://en.wikipedia.org/wiki/Phase_stretch_transform#:~:text=Phase%20stretch%20transform%20(PST)%20is,time%20stretch%20dispersive%20Fourier%20transform.) 
