---
layout: post
title: ä¼ æ„Ÿå™¨é¢œè‰²è°ƒåˆ¶ (å››) -- å¤šå…‰è°±é¢œè‰²æ ¡å‡†
categories:
  - algorithm
tags:
  - content
  - sensor
  - multi-spectrum
  - isp
  - proximal_operator
last_modified_at: 2025-02-21T09:56
created: 2025-02-12T18:56
---
## ç”¨RGBæ ¡å‡†å¤šå…‰è°±æ•°æ®

æŠŠ`(H,W,N)` çš„å¤šå…‰è°±æ•°æ® `Y` , ç”±`N x 3` çš„CCM(Color Correction Matrix) çº¿æ€§æ˜ å°„ä¸º `(H,W,3)` çš„rgbæ•°æ® `X` . å³ $Y\cdot CCM = X$ .

- è™½ç„¶æ˜¯çº¿æ€§æ˜ å°„, å¯ä»¥åœ¨æ­¥éª¤å‰ç»™Y åŠ ä¸€ä¸ª feature extractionæ¨¡å—, å®ç°éçº¿æ€§. è¾¾åˆ°æ›´ä½çš„loss.
- å³ä½¿åªæ˜¯çº¿æ€§æ˜ å°„, å¤šå…‰è°±æ•°æ®ä¹Ÿæ¯”3é€šé“çš„æ•°æ®èƒ½è¾¾åˆ°æ›´ä½çš„loss.
### æ±‚è§£ç³»æ•°

| Loss & çº¦æŸ               | å…¬å¼                                                                                     | è¯´æ˜                                                                                                                               |
| ----------------------- | -------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------- |
| æ™®é€šL2 norm               | $\min \vert\vert Y\cdot CCM - X\vert\vert_2$                                           |                                                                                                                                  |
| restrict awb            | $\min \vert\vert Y\cdot CCM - X\vert\vert_2$ ,  $\sum_{col}(CCM)=1$                    | è®©ä¸­æ€§ç°æ˜ å°„ä¸å˜, å³è®© (1,1,...,1)æ˜ å°„åˆ°(1,1,1)<br>ä¸€èˆ¬æ˜¯æŠŠwb(white balance)æ­¥éª¤æ”¾åœ¨color correctionä¹‹å‰ä¼šè¿™æ ·åš<br>å› ä¸ºwbåœ¨ä¸åŒæœºå™¨ä¸Šè¡¨ç°å·®åˆ«æ›´å¤§, <br>æ‰€ä»¥ç»™è¿™ä¸¤æ­¥è®¾ç½®ä¸åŒçš„æ ¡å‡†é¢‘ç‡å—? |
| L2 Regularization<br>ğŸŒŸ | $\min \vert\vert Y\cdot CCM - X\vert\vert_2 + \lambda\cdot\vert\vert CCM \vert\vert_2$ | é˜²æ­¢CCMå› ä¸ºæ•°æ®ç‚¹æ¯”è¾ƒå°‘è€Œè¿‡æ‹Ÿåˆ<br>å¦‚æœç”¨24è‰²å¡, è€ƒè™‘å¤šå…‰è°±æ•°æ®æœ‰ 3n ä¸ªæœªçŸ¥æ•°, <br>åŠ å…¥çº¦æŸæ˜¯ååˆ†å¿…è¦çš„, è¿™ä¸ªä¹Ÿæ˜¯è®¡ç®—æœ€ç®€å•çš„çº¦æŸæ¡ä»¶                                                   |
| Lasso                   | $\min \vert\vert Y\cdot CCM - X\vert\vert_2 + \lambda\cdot\vert\vert CCM \vert\vert_1$ | é˜²æ­¢CCMæŸä¸ªæ•°æ®è¿‡å¤§å¤–, è¿˜èƒ½å¢å¼ºç¨€ç–æ€§<br>åœ¨color-correctioné‡Œæ²¡å¿…è¦                                                                                   |
| CIELab<br>ğŸŒŸ            | æŠŠ X å˜æ¢åˆ°Labç©ºé—´. <br>è®¡ç®— $Y\cdot CCM$ å’Œ Xçš„delta E loss                                     | Lab æ˜¯è¯„åˆ¤RGBæ•°æ®æ˜¯å¦ç›¸è¿‘çš„æœ€ç»ˆæ ‡å‡†. è¿™ä¸€æ­¥ä¹Ÿæ˜¯å¿…è¦çš„.<br>Lab å˜æ¢æ˜¯éçº¿æ€§çš„, è¿™ä¸€æ­¥ä¼˜åŒ–æ—¶é—´æ›´é•¿.<br>éœ€è¦åœ¨çº¿æ€§ä¼˜åŒ–å¾—åˆ°åˆå€¼ä¹‹å, ç¬¬äºŒæ­¥å†åšdelta E çš„ä¼˜åŒ–.                                  |


1. **åŸå§‹L2 norm**:  ç”¨**æœ€å°äºŒä¹˜æ³•** 
2. **restrict awbæ¡ä»¶** : å› ä¸ºæ˜¯çº¿æ€§æ¡ä»¶, å¯ä»¥ç›´æ¥æ±‚è§£.
	- æŠŠawbæ¡ä»¶å†™æˆ: ![Pasted image 20250220192803.png]({{ '/docs/attachment/Pasted image 20250220192803.png' | relative_url }}){:width="300"} çš„å½¢å¼
	- ç›´æ¥ä»£å…¥åŸæ–¹ç¨‹: ![Pasted image 20250220192840.png]({{ '/docs/attachment/Pasted image 20250220192840.png' | relative_url }}){:width="1000"} 
		- æŠŠ Y å’Œ CCM åˆ†å—å±•å¼€å¹¶åŒ–ç®€. ç”¨**æœ€å°äºŒä¹˜æ³•**æ±‚è§£åŒ–ç®€åçš„æ–¹ç¨‹å³å¯.
3. **L2 Regularization** : å› ä¸ºæ­£åˆ™é¡¹ä¹Ÿæ˜¯L2çš„, å¯ä»¥ç›´æ¥è®¡ç®—. 
	- åœ¨æ±‚å¯¼æ—¶, CCMçš„ç³»æ•°ç”± $2Y^T Y$ å˜ä¸º $2Y^TY+2\begin{bmatrix}\lambda&& \\\ &\lambda& \\\ &&\lambda\end{bmatrix}$ å³å¯
4. **Lassoé—®é¢˜**: å¯ä»¥ç”¨è¿‘ç«¯ç®—å­è½®æµè¿­ä»£çš„æ–¹æ³•ä¼˜åŒ–.
5. **Delta E** : ç”¨BFGS çš„æ–¹æ³•ä¼˜åŒ–.

### æµ‹é‡æ ‡å‡†

- æ•°æ®æ¥æº:
	- æ ‡å‡†è‰²å¡
	- è‰²å·®ä»ªæµ‹é‡: ç†è®ºä¸Šèƒ½ç»„æˆå¾ˆå¤§çš„æ•°æ®é›†, ä½†æ˜¯å¾ˆå¤šææ–™æ²¡æœ‰å¥½çš„åå°„æ€§èƒ½
- æµ‹é‡ç¯å¢ƒ
	- ä¿è¯æµ‹é‡åˆ°çš„éƒ½æ˜¯åå°„å…‰
	- æ§åˆ¶å…‰æº, å¦‚æœç”¨è‰²å·®ä»ªå’Œè‰²å·®ä»ªçš„å…‰æºä¿æŒä¸€è‡´

### ç»“æœå¯è§†åŒ–

- è‰²å¡: ![color_check_result.png]({{ '/docs/attachment/color_check_result.png' | relative_url }}){:width="300"} æ˜¾ç¤ºæ ¡å‡†åå’Œæ ‡å‡†è‰²çš„ç›´è§‚å·®è·
- Labè‰²å½©: ![lab_chromaticities.png]({{ '/docs/attachment/lab_chromaticities.png' | relative_url }}){:width="200"} æ˜¾ç¤ºæ•°æ®é›†åœ¨abç©ºé—´çš„åˆ†å¸ƒ, ä»¥åŠæ ¡å‡†åçš„labè‰²å·®
- åœ¨ç»™å‡ºå¤šå…‰è°±sensoræ¯ä¸ªé€šé“çš„å…‰è°±(`cmf = n x 28` )çš„æƒ…å†µä¸‹, å¯ä»¥å‡ºç¤ºä¸‹é¢ä¸¤å›¾: ç”±`(cmf_T * cmf)^{-1} * cmf` åšä¸ºç³»æ•°, è¿˜å¯ä»¥åŠ å…¥ä¸€äº›Regularization
	- æ ¡å‡†æ•°æ®å…‰è°±: ![color_spectrum.png]({{ '/docs/attachment/color_spectrum.png' | relative_url }}){:width="300"}  æ˜¾ç¤ºæ•°æ®é›†çš„å…‰è°±åˆ†å¸ƒ.
	- [ ]  å¤šå…‰è°±æ˜ å°„çš„RGBå’ŒçœŸå®RGBçš„å…‰è°±å·®è·. å³è‰²å¡ä¸Šçš„çº¢, è“, ç»¿ä¸‰è‰². 

### ä»£ç 

- [**color_plot.py**](https://gist.github.com/roshameow/8855383a21cab1b36bba130a6cee70a5#file-color_plot-py) 

## ç”¨å¤šå…‰è°±åˆæˆé«˜å…‰è°±æ•°æ®

å¤šå…‰è°± + é«˜å…‰è°±åˆ†å¸ƒ -> é«˜å…‰è°±

- æ•°æ®é‡‡é›†: (å¤šå…‰è°±,é«˜å…‰è°±) æ•°æ®å¯¹
	- è‡ªç„¶çŠ¶æ€ä¸‹é‡‡é›†çš„é«˜å…‰è°±æ•°æ®é›†(åå°„å…‰+å…‰æº)
	- å¤šå…‰è°±æ•°æ®æ¯ä¸ªé€šé“å…‰è°± -> ç”±é«˜å…‰è°±æ•°æ®åˆæˆçš„å¤šå…‰è°±æ•°æ®
- æ¨¡å‹
	- è€ƒè™‘ç°å®ä¸–ç•Œæƒ…å†µ, å¸¦kernelçš„æ¨¡å‹([rbf](https://en.wikipedia.org/wiki/Radial_basis_function_network) )æ¯”è¾ƒåˆé€‚?

## ç”¨å¤šå…‰è°±åšawb

 å³åœ¨å¤šå…‰è°±æ•°æ®ä¸­å»æ‰å…‰æºçš„å½±å“. å¤šå…‰è°± + å…‰æºåˆ†å¸ƒ -> å…‰æºçš„ rgb illuminant vector. 

- æ•°æ®é‡‡é›†: (å¤šå…‰è°±, rgb illuminant vector) æ•°æ®å¯¹
	- è‡ªç„¶çŠ¶æ€ä¸‹é‡‡é›†çš„å…‰æºçš„é«˜å…‰è°±æ•°æ®é›† -> è½¬æ¢æˆå¤šå…‰è°±æ•°æ®é›†å’Œrgb illuminant vectoræ•°æ®é›†
	- ä»¿çœŸ: ä»å·²çŸ¥ (ç›¸æœºæ‹æ‘„çš„rgbå›¾ç‰‡,rgb illuminant vector)  + ç›¸æœºçš„responseæ›²çº¿ + å…‰æºçš„å…‰è°±æ•°æ®é›† + åå°„è°±æ•°æ®é›† -> æ¨æµ‹å‡ºå›¾ç‰‡æ¯ä¸ªåƒç´ çš„å…‰è°±
		- `ç›¸æœºçš„responseæ›²çº¿ * å…‰æºçš„å…‰è°± = rgb illuminant vector`
		- `ç›¸æœºçš„responseæ›²çº¿ *  å…‰æºçš„å…‰è°± * åå°„è°± = rgbåƒç´ `
		- ç”¨[æœ€å¤§ä¼¼ç„¶ä¼°è®¡](https://en.wikipedia.org/wiki/Maximum_likelihood_estimation) çš„æƒ³æ³•, å…ˆä¼°è®¡å‡ºå›¾ç‰‡å…‰æºå…‰è°±, å†ä¼°è®¡å‡ºæ¯ä¸ªåƒç´ çš„åå°„å…‰è°±

## reference

[1]  Koskinen, Samu, Erman Acar, and Joni-Kristian KÃ¤mÃ¤rÃ¤inen. â€œSingle Pixel Spectral Color Constancy.â€ _International Journal of Computer Vision_, September 1, 2023. [https://doi.org/10.1007/s11263-023-01867-x](https://doi.org/10.1007/s11263-023-01867-x).